{{- $js := resources.Get "js/stats.js" | resources.Minify -}}
<script src="{{ $js.RelPermalink }}"></script>

<style>
.blog-stats-container {
    display: flex;
    justify-content: space-around;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
    padding: 1.5rem;
    border-radius: 8px;
    background-color: var(--card-background);
    box-shadow: var(--shadow-l1);
    min-width: 150px;
    margin: 1rem;
    transition: transform 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 1.1rem;
    color: var(--card-text-color-secondary);
}

#last-updated {
    font-style: italic;
    color: var(--card-text-color-secondary);
}

@media (max-width: 600px) {
    .blog-stats-container {
        flex-direction: column;
        align-items: center;
    }
    
    .stat-item {
        width: 80%;
    }
}
</style>

<script>
// 获取文章总数
function getPostsCount() {
    // Hugo会在页面生成时提供这个数据
    return {{ len (where site.RegularPages "Type" "posts") }};
}

// 获取评论总数
async function getCommentsCount() {
    try {
        // 从hugo.toml获取giscus配置
        const repo = '{{ .Site.Params.comments.giscus.repo }}';
        const repoId = '{{ .Site.Params.comments.giscus.repoId }}';
        const categoryId = '{{ .Site.Params.comments.giscus.categoryId }}';
        
        // 使用GitHub REST API获取讨论数量
        const response = await fetch(`https://api.github.com/search/issues?q=repo:${repo}+type:discussions+category:${categoryId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/vnd.github.v3+json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch discussions count');
        }
        
        const data = await response.json();
        let totalComments = 0;
        
        // 获取讨论列表
        if (data.items && data.items.length > 0) {
            // 对每个讨论获取评论数
            for (const discussion of data.items) {
                const commentsResponse = await fetch(discussion.comments_url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                    }
                });
                
                if (commentsResponse.ok) {
                    const commentsData = await commentsResponse.json();
                    totalComments += commentsData.length;
                }
            }
        }
        
        return totalComments;
    } catch (error) {
        console.error('Error fetching comments count:', error);
        return 0;
    }
}

// 更新统计数据
async function updateStats() {
    // 更新文章数量
    const postsCount = getPostsCount();
    document.getElementById('posts-count').textContent = postsCount;
    
    // 更新评论数量
    const commentsCount = await getCommentsCount();
    document.getElementById('comments-count').textContent = commentsCount;
    
    // 更新最后更新时间
    const now = new Date();
    document.getElementById('last-updated').textContent = now.toLocaleString();
}

// 页面加载时更新统计数据
document.addEventListener('DOMContentLoaded', updateStats);
</script>