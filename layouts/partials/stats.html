{{- $js := resources.Get "js/stats.js" | resources.Minify -}}
<script src="{{ $js.RelPermalink }}"></script>

<style>
.stats-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
}

.stats-header {
    text-align: center;
    margin-bottom: 3rem;
    position: relative;
}

.stats-header h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: var(--accent-color);
    position: relative;
    display: inline-block;
}

.stats-header h1::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-color), transparent);
    border-radius: 3px;
}

.stats-header p {
    font-size: 1.1rem;
    color: var(--card-text-color-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.blog-stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin: 3rem 0;
}

.stat-item {
    background: var(--card-background);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: var(--shadow-l1);
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid var(--color-toc-border);
}

.stat-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
}

.stat-item:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-l2);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: var(--accent-color);
}

.stat-number {
    font-size: 3rem;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 0.5rem;
    font-family: var(--font-family-mono);
}

.stat-label {
    font-size: 1.2rem;
    color: var(--card-text-color-main);
    font-weight: 500;
}

.stats-info {
    background: var(--card-background);
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
    box-shadow: var(--shadow-l1);
    border: 1px solid var(--color-toc-border);
}

.stats-info h3 {
    color: var(--accent-color);
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.stats-info p {
    color: var(--card-text-color-secondary);
    line-height: 1.6;
    margin-bottom: 1rem;
}

.stats-footer {
    text-align: center;
    margin-top: 3rem;
    color: var(--card-text-color-secondary);
    font-style: italic;
}

#last-updated {
    display: inline-block;
    margin-left: 0.5rem;
    font-weight: 500;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top-color: var(--accent-color);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .stats-page {
        padding: 1rem;
    }
    
    .stats-header h1 {
        font-size: 2rem;
    }
    
    .blog-stats-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .stat-item {
        padding: 1.5rem;
    }
    
    .stat-number {
        font-size: 2.5rem;
    }
}
</style>

<div class="stats-page">
    <div class="stats-header">
        <h1>åšå®¢ç»Ÿè®¡</h1>
        <p>æ¬¢è¿æŸ¥çœ‹æˆ‘çš„åšå®¢ç»Ÿè®¡æ•°æ®ï¼Œè¿™é‡Œå±•ç¤ºäº†åšå®¢çš„æ–‡ç« æ•°é‡å’Œè¯„è®ºæ•°é‡ç­‰åŸºæœ¬ä¿¡æ¯ã€‚</p>
    </div>
    
    <div class="blog-stats-container">
        <div class="stat-item">
            <div class="stat-icon">ğŸ“</div>
            <div class="stat-number" id="posts-count">
                <div class="loading"></div>
            </div>
            <div class="stat-label">æ–‡ç« æ€»æ•°</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-icon">ğŸ’¬</div>
            <div class="stat-number" id="comments-count">
                <div class="loading"></div>
            </div>
            <div class="stat-label">è¯„è®ºæ€»æ•°</div>
        </div>
    </div>
    
    <div class="stats-info">
        <h3>æ•°æ®è¯´æ˜</h3>
        <p><strong>æ–‡ç« æ€»æ•°ï¼š</strong>æ˜¾ç¤ºåšå®¢ä¸­å·²å‘å¸ƒçš„æ–‡ç« æ•°é‡ï¼Œä¸åŒ…æ‹¬è‰ç¨¿å’Œæœªæ¥å‘å¸ƒçš„æ–‡ç« ã€‚</p>
        <p><strong>è¯„è®ºæ€»æ•°ï¼š</strong>æ˜¾ç¤ºé€šè¿‡Giscusè¯„è®ºç³»ç»Ÿå‘è¡¨çš„æ‰€æœ‰è¯„è®ºæ•°é‡ï¼Œæ•°æ®æ¥æºäºGitHub Discussionsã€‚</p>
        <p>ç»Ÿè®¡æ•°æ®ä¼šåœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ·æ–°é¡µé¢è·å–æœ€æ–°æ•°æ®ã€‚</p>
    </div>
    
    <div class="stats-footer">
        æœ€åæ›´æ–°æ—¶é—´ï¼š<span id="last-updated">åŠ è½½ä¸­...</span>
    </div>
</div>

<script>
// è·å–æ–‡ç« æ€»æ•°
function getPostsCount() {
    // Hugoä¼šåœ¨é¡µé¢ç”Ÿæˆæ—¶æä¾›è¿™ä¸ªæ•°æ®
    return {{ len (where site.RegularPages "Type" "posts") }};
}

// è·å–è¯„è®ºæ€»æ•°
async function getCommentsCount() {
    try {
        // ä»hugo.tomlè·å–giscusé…ç½®
        const repo = '{{ .Site.Params.comments.giscus.repo }}';
        const repoId = '{{ .Site.Params.comments.giscus.repoId }}';
        const categoryId = '{{ .Site.Params.comments.giscus.categoryId }}';
        
        // ä½¿ç”¨GitHub REST APIè·å–è®¨è®ºæ•°é‡
        const response = await fetch(`https://api.github.com/search/issues?q=repo:${repo}+type:discussions+category:${categoryId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/vnd.github.v3+json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch discussions count');
        }
        
        const data = await response.json();
        let totalComments = 0;
        
        // è·å–è®¨è®ºåˆ—è¡¨
        if (data.items && data.items.length > 0) {
            // å¯¹æ¯ä¸ªè®¨è®ºè·å–è¯„è®ºæ•°
            for (const discussion of data.items) {
                const commentsResponse = await fetch(discussion.comments_url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                    }
                });
                
                if (commentsResponse.ok) {
                    const commentsData = await commentsResponse.json();
                    totalComments += commentsData.length;
                }
            }
        }
        
        return totalComments;
    } catch (error) {
        console.error('Error fetching comments count:', error);
        return 0;
    }
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
async function updateStats() {
    // æ›´æ–°æ–‡ç« æ•°é‡
    const postsCount = getPostsCount();
    document.getElementById('posts-count').textContent = postsCount;
    
    // æ›´æ–°è¯„è®ºæ•°é‡
    const commentsCount = await getCommentsCount();
    document.getElementById('comments-count').textContent = commentsCount;
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    const now = new Date();
    document.getElementById('last-updated').textContent = now.toLocaleString();
}

// é¡µé¢åŠ è½½æ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®
document.addEventListener('DOMContentLoaded', updateStats);
</script>